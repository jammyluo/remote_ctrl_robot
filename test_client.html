<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>远程控制测试客户端</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            background: #e8f5e8;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .error {
            background: #ffe8e8;
            color: #d32f2f;
        }
        .success {
            background: #e8f5e8;
            color: #2e7d32;
        }
        .warning {
            background: #fff3e0;
            color: #f57c00;
        }
        button {
            background: #2196f3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #1976d2;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .btn-danger {
            background: #f44336;
        }
        .btn-danger:hover {
            background: #d32f2f;
        }
        .btn-success {
            background: #4caf50;
        }
        .btn-success:hover {
            background: #388e3c;
        }
        input, select {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .command-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .video-container {
            width: 100%;
            height: 200px;
            background: #000;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            margin-bottom: 10px;
        }
        .webrtc-info {
            background: #f0f8ff;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
        }
        .robot-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 10px 0;
        }
        .info-item {
            background: #f5f5f5;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
        }
        .direction-control {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
        }
        .direction-row {
            display: flex;
            gap: 10px;
        }
        .direction-btn {
            width: 80px;
            height: 80px;
            background: #2196f3;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.2s;
            user-select: none;
            -webkit-user-select: none;
        }
        .direction-btn:hover {
            background: #1976d2;
            transform: scale(1.05);
        }
        .direction-btn:active {
            background: #0d47a1;
            transform: scale(0.95);
        }
        .direction-btn.active {
            background: #0d47a1;
            box-shadow: 0 0 10px rgba(13, 71, 161, 0.5);
        }
        .action-control {
            display: flex;
            justify-content: center;
            margin: 15px 0;
        }
        .action-btn {
            width: 100px;
            height: 80px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.2s;
            user-select: none;
            -webkit-user-select: none;
        }
        .action-btn:hover {
            background: #d32f2f;
            transform: scale(1.05);
        }
        .action-btn:active {
            background: #b71c1c;
            transform: scale(0.95);
        }
        .action-btn.active {
            background: #b71c1c;
            box-shadow: 0 0 10px rgba(183, 28, 28, 0.5);
        }
        .status-success {
            color: #4caf50;
            font-weight: bold;
        }
        .status-error {
            color: #f44336;
            font-weight: bold;
        }
        .status-warning {
            color: #ff9800;
            font-weight: bold;
        }
        .status-disconnected {
            color: #f44336;
            font-weight: bold;
        }
        .status-display {
            margin: 10px 0;
            padding: 8px;
            background: #f5f5f5;
            border-radius: 4px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <h1>🎮 机器人远程控制操作者页面</h1>
    
    <div class="container">
        <!-- 控制面板 -->
        <div class="panel">
            <h2>🎮 操作者控制面板</h2>
            <p style="color: #666; margin-bottom: 20px;">
                通过机器人UCode绑定到特定机器人，然后进行远程控制
            </p>
            
            <div class="form-group">
                <label>机器人UCode (要控制的机器人):</label>
                <input type="text" id="robotUCode" value="test_robot_001" placeholder="输入要控制的机器人唯一标识" />
            </div>
            
            <div class="form-group">
                <label>操作者标识:</label>
                <input type="text" id="operatorId" value="operator_001" placeholder="输入操作者标识" />
            </div>
            
            <div class="form-group">
                <label>操作者名称 (可选):</label>
                <input type="text" id="clientName" value="测试操作者" placeholder="输入操作者名称" />
            </div>
            
            <div class="form-group">
                <label>版本 (可选):</label>
                <input type="text" id="clientVersion" value="1.0.0" placeholder="输入客户端版本" />
            </div>
            
            <div class="status-display">
                <span>连接状态: </span>
                <span id="connectionStatus" class="status-disconnected">未连接</span>
            </div>
            
            <div class="status-display">
                <span>当前动作: </span>
                <span id="currentAction" class="status-disconnected">无</span>
            </div>
            
            <div>
                <button onclick="connectAndRegister()">连接并绑定机器人</button>
                <button onclick="disconnect()">断开</button>
            </div>
            
            <h3>方向控制</h3>
            <div class="direction-control">
                <div class="direction-row">
                    <button class="direction-btn" id="forwardBtn" 
                            onmousedown="startMove('forward')" 
                            onmouseup="stopMove()" 
                            ontouchstart="startMove('forward')" 
                            ontouchend="stopMove()">
                        ⬆️ 向前
                    </button>
                </div>
                <div class="direction-row">
                    <button class="direction-btn" id="leftBtn" 
                            onmousedown="startMove('left')" 
                            onmouseup="stopMove()" 
                            ontouchstart="startMove('left')" 
                            ontouchend="stopMove()">
                        ⬅️ 向左
                    </button>
                    <button class="direction-btn" id="rightBtn" 
                            onmousedown="startMove('right')" 
                            onmouseup="stopMove()" 
                            ontouchstart="startMove('right')" 
                            ontouchend="stopMove()">
                        ➡️ 向右
                    </button>
                </div>
                <div class="direction-row">
                    <button class="direction-btn" id="backwardBtn" 
                            onmousedown="startMove('backward')" 
                            onmouseup="stopMove()" 
                            ontouchstart="startMove('backward')" 
                            ontouchend="stopMove()">
                        ⬇️ 向后
                    </button>
                </div>
            </div>
            
            <h3>动作控制</h3>
            <div class="action-control">
                <button class="action-btn btn-danger" id="shootBtn" 
                        onmousedown="startShoot()" 
                        onmouseup="stopShoot()" 
                        ontouchstart="startShoot()" 
                        ontouchend="stopShoot()">
                    🔫 射击
                </button>
            </div>
            
            <h3>自定义命令</h3>
            <div class="form-group">
                <label>命令类型:</label>
                <select id="commandType">
                    <option value="emergency_stop">紧急停止</option>
                    <option value="home">回零位</option>
                    <option value="start">启动</option>
                    <option value="stop">停止</option>
                    <option value="pause">暂停</option>
                    <option value="resume">恢复</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>优先级 (1-10):</label>
                <input type="number" id="priority" value="5" min="1" max="10" />
            </div>
            
            <div>
                <button onclick="sendCommand()">发送自定义命令</button>
                <button onclick="sendPing()">发送Ping</button>
                <button onclick="requestStatus()">请求状态</button>
            </div>
        </div>
        
        <!-- 状态面板 -->
        <div class="panel">
            <h2>📊 状态监控</h2>
            
            <div id="robotStatus" class="status">
                机器人状态: 未知
            </div>
            
            <div id="systemStatus" class="status">
                系统状态: 未知
            </div>
            
            <div class="robot-info">
                <div class="info-item">
                    <div>活跃客户端</div>
                    <div id="activeClients">0</div>
                </div>
                <div class="info-item">
                    <div>连接状态</div>
                    <div id="connectionState">未连接</div>
                </div>
            </div>
            
            <div id="clientInfo" class="webrtc-info" style="display: none;">
                <!-- 客户端信息将在这里显示 -->
            </div>
            
            <div id="clientStats" class="webrtc-info" style="display: none;">
                <!-- 客户端统计信息将在这里显示 -->
            </div>
            
            <h3>WebRTC视频流</h3>
            <div class="video-container" id="videoContainer">
                视频流未连接
            </div>
            
            <div class="webrtc-info" id="webrtcInfo" style="display: none;">
                <strong>WebRTC信息:</strong><br>
                <div id="webrtcDetails"></div>
            </div>
            
            <div>
                <button onclick="getWebRTCUrls()">获取播放地址</button>
            </div>
            
            <h3>日志</h3>
            <div class="log" id="log"></div>
            <button onclick="clearLog()">清空日志</button>
        </div>
    </div>

    <script>
        let ws = null;
        let isConnected = false;
        let isRegistered = false;
        let currentUCode = '';
        let currentDirection = null;
        let isShooting = false;
        let moveInterval = null;
        let shootInterval = null;

        // 连接并注册WebSocket
        function connectAndRegister() {
            const serverUrl = 'http://localhost:8000'; // 固定服务器地址
            const wsUrl = serverUrl.replace('http', 'ws') + '/ws/control';
            
            log('尝试连接到: ' + wsUrl);
            
            try {
                ws = new WebSocket(wsUrl);
                log('WebSocket对象已创建，状态: ' + ws.readyState);
                
                ws.onopen = function() {
                    isConnected = true;
                    log('✅ WebSocket连接已建立，状态: ' + ws.readyState);
                    updateConnectionStatus('已连接', 'success');
                    
                    // 连接成功后自动注册
                    setTimeout(registerClient, 500);
                };
                
                ws.onmessage = function(event) {
                    log('收到原始消息: ' + event.data);
                    try {
                        const message = JSON.parse(event.data);
                        handleMessage(message);
                    } catch (error) {
                        log('❌ 解析消息失败: ' + error.message);
                    }
                };
                
                ws.onclose = function(event) {
                    isConnected = false;
                    isRegistered = false;
                    log('❌ WebSocket连接已断开，代码: ' + event.code + ', 原因: ' + event.reason);
                    updateConnectionStatus('连接已断开', 'error');
                };
                
                ws.onerror = function(error) {
                    log('❌ WebSocket连接错误: ' + error);
                    updateConnectionStatus('连接错误', 'error');
                };
                
            } catch (error) {
                log('❌ 创建WebSocket连接失败: ' + error.message);
                console.error('连接错误详情:', error);
            }
        }

        // 断开连接
        function disconnect() {
            // 清除所有定时器
            if (moveInterval) {
                clearInterval(moveInterval);
                moveInterval = null;
            }
            if (shootInterval) {
                clearInterval(shootInterval);
                shootInterval = null;
            }
            
            // 重置状态
            currentDirection = null;
            isShooting = false;
            
            // 清除所有按钮的视觉反馈
            const directionButtons = ['forwardBtn', 'backwardBtn', 'leftBtn', 'rightBtn'];
            directionButtons.forEach(btnId => {
                const button = document.getElementById(btnId);
                if (button) {
                    button.classList.remove('active');
                }
            });
            
            const shootButton = document.getElementById('shootBtn');
            if (shootButton) {
                shootButton.classList.remove('active');
            }
            
            // 清除动作状态
            updateCurrentAction(null);
            
            // 断开WebSocket连接
            if (ws) {
                ws.close();
            }
        }

        // 注册客户端（内部函数，连接成功后自动调用）
        function registerClient() {
            log('开始绑定机器人...');
            log('连接状态: ' + (isConnected ? '已连接' : '未连接'));
            log('WebSocket对象: ' + (ws ? '存在' : '不存在'));
            
            if (!isConnected) {
                log('错误: 未连接到服务器');
                return;
            }

            if (!ws) {
                log('错误: WebSocket对象不存在');
                return;
            }

            const robotUCode = document.getElementById('robotUCode').value;
            const operatorId = document.getElementById('operatorId').value;
            const clientName = document.getElementById('clientName').value;
            const clientVersion = document.getElementById('clientVersion').value;

            log('机器人UCode: ' + robotUCode);
            log('操作者标识: ' + operatorId);
            log('操作者名称: ' + clientName);
            log('客户端版本: ' + clientVersion);

            if (!robotUCode) {
                log('错误: 请输入机器人UCode');
                return;
            }

            if (!operatorId) {
                log('错误: 请输入操作者标识');
                return;
            }

            const message = {
                type: 'register',
                robot_ucode: robotUCode,  // 使用机器人UCode
                client_type: 'operator',
                name: clientName,
                version: clientVersion,
                operator_id: operatorId  // 添加操作者标识
            };

            try {
                const messageStr = JSON.stringify(message);
                log('准备发送绑定消息: ' + messageStr);
                log('WebSocket readyState: ' + ws.readyState);
                
                if (ws.readyState === WebSocket.OPEN) {
                    ws.send(messageStr);
                    log('✅ 绑定消息发送成功');
                } else {
                    log('❌ WebSocket未处于OPEN状态，当前状态: ' + ws.readyState);
                }
            } catch (error) {
                log('❌ 发送绑定消息时发生错误: ' + error.message);
                console.error('发送错误详情:', error);
            }
        }

        // 开始移动
        function startMove(direction) {
            if (!isConnected || !isRegistered) {
                log('错误: 未连接或未注册');
                return;
            }

            // 如果已经在移动，先停止之前的移动
            if (moveInterval) {
                clearInterval(moveInterval);
            }

            currentDirection = direction;
            log('开始移动: ' + direction);

            // 添加视觉反馈
            const buttonId = direction + 'Btn';
            const button = document.getElementById(buttonId);
            if (button) {
                button.classList.add('active');
            }

            // 更新动作状态
            updateCurrentAction('移动: ' + direction);

            // 立即发送一次开始命令
            sendMoveCommand(direction, 'start');

            // 设置定时器，每500毫秒发送一次移动命令
            moveInterval = setInterval(() => {
                sendMoveCommand(direction, 'continue');
            }, 500);
        }

        // 停止移动
        function stopMove() {
            if (!isConnected || !isRegistered || !currentDirection) {
                return;
            }

            // 清除定时器
            if (moveInterval) {
                clearInterval(moveInterval);
                moveInterval = null;
            }

            // 移除视觉反馈
            const buttonId = currentDirection + 'Btn';
            const button = document.getElementById(buttonId);
            if (button) {
                button.classList.remove('active');
            }

            // 发送停止命令
            sendMoveCommand(currentDirection, 'stop');
            log('停止移动: ' + currentDirection);
            currentDirection = null;
            
            // 更新动作状态
            updateCurrentAction(null);
        }

        // 发送移动命令
        function sendMoveCommand(direction, action) {
            const command = {
                type: 'move',
                direction: direction,
                action: action,
                priority: 5,
                command_id: 'move_' + direction + '_' + action + '_' + Date.now(),
                timestamp: Date.now()
            };

            const message = {
                type: 'control_command',
                message: action + ' move: ' + direction,
                data: command
            };

            ws.send(JSON.stringify(message));
        }

        // 开始射击
        function startShoot() {
            if (!isConnected || !isRegistered) {
                log('错误: 未连接或未注册');
                return;
            }

            // 如果已经在射击，先停止之前的射击
            if (shootInterval) {
                clearInterval(shootInterval);
            }

            isShooting = true;
            log('开始射击');

            // 添加视觉反馈
            const button = document.getElementById('shootBtn');
            if (button) {
                button.classList.add('active');
            }

            // 更新动作状态
            updateCurrentAction('射击');

            // 立即发送一次开始命令
            sendShootCommand('start');

            // 设置定时器，每500毫秒发送一次射击命令
            shootInterval = setInterval(() => {
                sendShootCommand('continue');
            }, 500);
        }

        // 停止射击
        function stopShoot() {
            if (!isConnected || !isRegistered || !isShooting) {
                return;
            }

            // 清除定时器
            if (shootInterval) {
                clearInterval(shootInterval);
                shootInterval = null;
            }

            // 移除视觉反馈
            const button = document.getElementById('shootBtn');
            if (button) {
                button.classList.remove('active');
            }

            // 发送停止命令
            sendShootCommand('stop');
            log('停止射击');
            isShooting = false;
            
            // 更新动作状态
            updateCurrentAction(null);
        }

        // 发送射击命令
        function sendShootCommand(action) {
            const command = {
                type: 'shoot',
                action: action,
                priority: 7,
                command_id: 'shoot_' + action + '_' + Date.now(),
                timestamp: Date.now()
            };

            const message = {
                type: 'control_command',
                message: action + ' shooting',
                data: command
            };

            ws.send(JSON.stringify(message));
        }

        // 发送控制命令
        function sendCommand() {
            if (!isConnected || !isRegistered) {
                log('错误: 未连接或未注册');
                return;
            }

            const commandType = document.getElementById('commandType').value;
            const priority = parseInt(document.getElementById('priority').value);
            
            const command = {
                type: commandType,
                priority: priority,
                command_id: 'cmd_' + Date.now(),
                timestamp: Date.now()
            };

            const message = {
                type: 'control_command',
                message: 'Control command from client',
                data: command
            };

            ws.send(JSON.stringify(message));
            log('发送命令: ' + JSON.stringify(command));
        }

        // 发送ping
        function sendPing() {
            if (!isConnected) {
                log('错误: 未连接到服务器');
                return;
            }

            const message = {
                type: 'ping',
                message: 'Ping from client'
            };

            ws.send(JSON.stringify(message));
            log('发送ping');
        }

        // 请求状态
        function requestStatus() {
            if (!isConnected) {
                log('错误: 未连接到服务器');
                return;
            }

            const message = {
                type: 'status_request',
                message: 'Status request from client'
            };

            ws.send(JSON.stringify(message));
            log('请求状态');
        }

        // 获取WebRTC播放地址
        async function getWebRTCUrls() {
            const robotUCode = document.getElementById('robotUCode').value;
            if (!robotUCode) {
                log('错误: 请输入机器人UCode');
                return;
            }

            try {
                const serverUrl = 'http://localhost:8080';
                const response = await fetch(serverUrl + '/api/v1/webrtc/play-url?ucode=' + robotUCode);
                const data = await response.json();
                
                if (data.success) {
                    log('获取WebRTC播放地址成功');
                    document.getElementById('videoContainer').innerHTML = 
                        '播放地址数量: ' + data.urls.length + '<br><br>' +
                        data.urls.map((url, index) => `URL ${index + 1}: ${url}`).join('<br>');
                } else {
                    log('获取WebRTC播放地址失败: ' + data.message);
                }
            } catch (error) {
                log('获取WebRTC播放地址错误: ' + error.message);
            }
        }

        // 处理接收到的消息
        function handleMessage(message) {
            log('收到消息: ' + JSON.stringify(message));
            
            switch (message.type) {
                case 'register_response':
                    if (message.data && message.data.success) {
                        isRegistered = true;
                        const data = message.data;
                        log('操作者绑定机器人成功: ' + data.ucode + ' (' + data.client_type + ')');
                        updateConnectionStatus('已连接并绑定机器人: ' + data.ucode, 'success');
                        
                        // 更新界面显示客户端信息
                        updateClientInfo(data);
                    } else {
                        const error = message.data ? message.data.error : message.message;
                        log('操作者绑定机器人失败: ' + error);
                        updateConnectionStatus('绑定失败', 'error');
                    }
                    break;
                    
                case 'pong':
                    log('收到pong响应');
                    break;
                    
                case 'status_response':
                    log('收到状态响应: ' + JSON.stringify(message.data));
                    updateSystemStatus(message.data);
                    break;
                    
                case 'control_response':
                    log('收到控制响应: ' + JSON.stringify(message.data));
                    break;
                    
                case 'error':
                    log('服务器错误: ' + message.error);
                    break;
                    
                default:
                    log('未知消息类型: ' + message.type);
            }
        }

        // 更新客户端信息显示
        function updateClientInfo(data) {
            const clientInfoDiv = document.getElementById('clientInfo');
            if (clientInfoDiv) {
                clientInfoDiv.style.display = 'block';
                clientInfoDiv.innerHTML = `
                    <strong>绑定信息:</strong><br>
                    机器人UCode: ${data.ucode}<br>
                    操作者类型: ${data.client_type}<br>
                    绑定时间: ${new Date(data.timestamp).toLocaleString()}
                `;
            }
        }

        // 更新系统状态
        function updateSystemStatus(data) {
            if (data.clients) {
                const clients = data.clients;
                document.getElementById('activeClients').textContent = clients.total || 0;
                
                // 更新客户端统计信息
                const clientStatsDiv = document.getElementById('clientStats');
                if (clientStatsDiv) {
                    clientStatsDiv.style.display = 'block';
                    clientStatsDiv.innerHTML = `
                        <strong>客户端统计:</strong><br>
                        总数: ${clients.total}<br>
                        机器人: ${clients.robots}<br>
                        操作者: ${clients.operators}
                    `;
                }
            }
        }

        // 更新连接状态
        function updateConnectionStatus(status, type) {
            const statusElement = document.getElementById('connectionStatus');
            if (statusElement) {
                statusElement.textContent = status;
                statusElement.className = 'status-' + type;
            }
        }

        // 更新当前动作状态
        function updateCurrentAction(action) {
            const actionElement = document.getElementById('currentAction');
            if (actionElement) {
                if (action) {
                    actionElement.textContent = action;
                    actionElement.className = 'status-success';
                } else {
                    actionElement.textContent = '无';
                    actionElement.className = 'status-disconnected';
                }
            }
        }

        // 更新机器人状态
        function updateRobotStatus(status, type) {
            const element = document.getElementById('robotStatus');
            element.textContent = '机器人状态: ' + status;
            element.className = 'status ' + type;
        }

        // 记录日志
        function log(message) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            
            if (logElement) {
                logElement.innerHTML += logEntry + '<br>';
                logElement.scrollTop = logElement.scrollHeight;
            }
            
            console.log(logEntry);
        }

        // 清空日志
        function clearLog() {
            const logElement = document.getElementById('log');
            if (logElement) {
                logElement.innerHTML = '';
            }
        }

        // 页面加载时自动连接
        window.onload = function() {
            log('页面加载完成，准备连接服务器...');
        };

        // 页面卸载时断开连接
        window.onbeforeunload = function() {
            // 清除所有定时器
            if (moveInterval) {
                clearInterval(moveInterval);
                moveInterval = null;
            }
            if (shootInterval) {
                clearInterval(shootInterval);
                shootInterval = null;
            }
            
            // 断开WebSocket连接
            if (ws) {
                ws.close();
            }
        };
    </script>
</body>
</html> 